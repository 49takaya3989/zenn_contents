---
title: "TanStack Query ã®å°å…¥"
emoji: "ğŸ¡"
type: "tech"
topics:
  - "tanstackquery"
published: true
published_at: "2024-03-31 17:16"
---

# ã¯ã˜ã‚ã«
ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰â†“
https://github.com/49takaya3989/sample_tanstack-query

# é–‹ç™ºç’°å¢ƒ
```json
"@tanstack/react-query": "^5.28.6",
"@tanstack/react-query-devtools": "^5.28.10",
"@tanstack/eslint-plugin-query": "^5.28.6",
```
# TanStack Query ã¨ã¯ï¼Ÿ
> TanStack Query (FKA React Query) ã¯ã€Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¸è¶³ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã‚ˆãèª¬æ˜ã•ã‚Œã¾ã™ãŒã€ã‚ˆã‚ŠæŠ€è¡“çš„ã«è¨€ãˆã°ã€ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã®å–å¾—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€åŒæœŸã€æ›´æ–°ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
> ã»ã¨ã‚“ã©ã®ã‚³ã‚¢ Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯ã€å…¨ä½“çš„ãªæ–¹æ³•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã¾ãŸã¯æ›´æ–°ã™ã‚‹ãŸã‚ã®ç‹¬è‡ªã®æ–¹æ³•ãŒä»˜å±ã—ã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ãŸã‚ã€é–‹ç™ºè€…ã¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã«é–¢ã™ã‚‹å³å¯†ãªæ„è¦‹ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ãŸãƒ¡ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹ã‹ã€ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿å–å¾—æ–¹æ³•ã‚’ç™ºæ˜ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯é€šå¸¸ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã¨å‰¯ä½œç”¨ã‚’çµ„ã¿åˆã‚ã›ãŸã‚Šã€ã‚ˆã‚Šæ±ç”¨çš„ãªçŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªå…¨ä½“ã«éåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãŠã‚ˆã³æä¾›ã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

https://tanstack.com/query/latest/docs/framework/react/overview

å··ã§ã¯ã‚ˆãã€ TanStack Query ã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ãŒã€
å…¬å¼ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã®Dominikã•ã‚“ã‚‚[è¨€åŠã•ã‚Œã¦ã„ã‚‹](https://tkdodo.eu/blog/thinking-in-react-query)ã‚ˆã†ã«ã€ä¸»ãªç›®çš„ã¯ã€**åŠ¹ç‡çš„ãªéåŒæœŸçŠ¶æ…‹ã®ç®¡ç†**ã§ã‚ã‚‹ã€‚

# å°å…¥
ä»Šå›ã¯ç·´ç¿’ã¨ã—ã¦ã‚ˆãä½¿ã‚ã‚Œã‚‹ TODO ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã„ãã€‚
DB ã¯ Firebase ã§è¡Œã†ãŒã€Firebase ã®æ§‹ç¯‰ã‚„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«é–¢ã™ã‚‹èª¬æ˜ã¯è¡Œã‚ãªã„ã®ã§ã€ã‚ã‹ã‚‰ãªã„æ–¹ã¯ChatGPTã«èã„ã¦ã¿ã¦ãã ã•ã„ã€‚
ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆReactã®ç’°å¢ƒæ§‹ç¯‰ã¯çµ‚ã‚ã£ã¦ã„ã‚‹å‰æï¼‰ã‚’æŠ•ã’ã‚Œã°æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
```
react + firebseã®ã‚³ãƒ¼ãƒ‰æ•™ãˆã¦ã€‚
reactã®æ§‹ç¯‰ã¯çµ‚ã‚ã£ã¦ã¾ã™ã€‚
```

1. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. Eslint ã«è¨­å®šã‚’è¿½åŠ 
3. TanStack Query ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¥ç¶š
4. å®Ÿè£…


## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
[å…¬å¼](https://tanstack.com/query/latest/docs/framework/react/overview)ã‚’å‚è€ƒã«é€²ã‚ã¦ã„ãã€‚
ä»Šå›ã¯ä¸‹è¨˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```
npm i @tanstack/react-query @tanstack/react-query-devtools
npm i -D @tanstack/eslint-plugin-query
```
@tanstack/eslint-plugin-queryï¼šeslint ã§ã‚¿ã‚¤ãƒãªã©ã‚’é˜²ããŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
@tanstack/react-query-devtoolsï¼šTanStack Query ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã® Devtool ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
## Eslint ã«è¨­å®šã‚’è¿½åŠ 
```diff js
module.exports = {
  ãƒ»ãƒ»ãƒ»
  extends: [
    ãƒ»ãƒ»ãƒ»
+   'plugin:@tanstack/eslint-plugin-query/recommended',
  ],
}

```
## TanStack Query ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¥ç¶š
ã¾ãšã¯ã€æ¥ç¶šã™ã‚‹ã®ã«å¿…è¦ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
```tsx
const queryClient = new QueryClient()
```
ã“ã‚Œã ã‘ã§ã™ï¼
æ¬¡ã«ã€ä¸Šè¨˜ã§ä½œæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ Provider ã¨ä¸€ç·’ã«å®šç¾©ã—ã¾ã™ã€‚
```tsx
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </React.StrictMode>,
)
```
ã“ã‚Œã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã®æ¥ç¶šã¯å®Œäº†ï¼
ã“ã‚Œã«åŠ ãˆã¦ä»Šå›ã¯ã€TanStack Query ã®çŠ¶æ…‹ã‚’ç¢ºèªã§ãã‚‹ Devtool ã‚’ä½¿ã„ãŸã„ã®ã§ã€ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff tsx
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
+     <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  </React.StrictMode>,
)
```
## å®Ÿè£…
åŸºæœ¬çš„ã« API ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢ä¿‚ã§ä½¿ã†é–¢æ•°ã¯ã€`useQuery`ã¨`useMutation`ãªã®ã§ã“ã®2ã¤ã«çµã£ã¦å®Ÿè£…ã™ã‚‹ã€‚
ç´°ã‹ã„èª¬æ˜ã¯å…¬å¼ã‚„å‚è€ƒè¨˜äº‹ã«è¨˜è¼‰ãŒãŸãã•ã‚“ã‚ã‚‹ã®ã§ã€ä»Šå›ã¯ã“ã†æ›¸ã‘ã°ä½¿ãˆã‚‹ã¨ã„ã†ã“ã¨ã‚’ç›®çš„ã«èª¬æ˜ã—ã¦ã„ãã€‚
```tsx
interface Task {
  id: string;
  task: string;
  completed: boolean;
}

// useQuery
export const useLoadTasks = () => {
  const { data, isPending } = useQuery({
    queryKey: ["task", "list"],
    queryFn: async () => {
      await getDocs(tasksCollectionRef)
        .then(res => res.docs.map(el => (
          {...el.data(), id: el.id} as Task
        )));
    },
  })

  return { data, isPending }
}

// useMutation
export const useCreateTask = () => {
  const mutateCreate = useMutation({
    mutationFn: async (newTask: string) =>
      await addDoc(tasksCollectionRef, { task: newTask, completed: false });
  })

  return { mutateCreate }
}

const App: React.FC = () => {
  const { data, isPending } = useLoadTasks()
  const { mutateCreate } = useCreateTask()
  const [newValue, setNewValue] = useState('')
  ãƒ»ãƒ»ãƒ»
  const submitHandler = useCallback(
    (e: FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      mutateCreate.mutate(
        newValue,
      );
    },
    [mutateCreate, newValue]
  )
  ãƒ»ãƒ»ãƒ»
  return (
    <div>
      <form onSubmit={submitHandler}>
        <input
          type="text"
          value={newValue}
          onChange={(e) => setNewValue(e.target.value)}
          placeholder="Add a new task"
        />
        <button>Add Task</button>
      </form>
      {isPending
        ? '...loading'
        : (
          <div>
            {data && data.map((task) => <div key={task.id}>ãƒ»ãƒ»ãƒ»</div>)}
          </div>
        )
      }
    </div>
  );
}

export default App;
```
useQuery ã«ã¯ã€ queryKey ã¨ queryFn 2ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ useMutation ã«ã¯ queryFn 1ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¿…è¦ã¨ãªã‚‹ã€‚
`queryKey`
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚‚ã®ã€‚ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚‚ã®ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
`queryFn`
APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®é–¢æ•°ã€‚

ç”»é¢å³ä¸‹ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹â†“ã®ã‚ˆã†ãªã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ TanStack Query ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/20c0576e7d68-20240331.png)
ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ queryKey ã«ç´ã¥ã„ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/8339912b30cb-20240331.png)

### ï¼ˆå¿œç”¨ï¼‰ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
åŸºæœ¬çš„ã«ã¯ä¸Šè¨˜ã§å‹•ãã‚ˆã†ã«ãªã‚‹ãŒã€ã‚³ãƒ¼ãƒ‰ç®¡ç†ãŒã‚„ã‚Šã¥ã‚‰ã„ã®ã§åˆ‡ã‚Šåˆ†ã‘ã¦ã„ãã€‚
ã¾ãšåˆã‚ã«ã€ API ã‚’å©ããŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã—ã¦ /service/task ã‚’ä½œæˆã™ã‚‹ã€‚
```
mkdir src/service/task
```
ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«ã€5ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
```
cd src/service/task && touch function.ts index.ts key.ts selector.ts type.ts
```
`function.ts`
mutationFn ã«è¨˜è¼‰ã™ã‚‹ã€APIã‚’å©ããŸã‚ã®é–¢æ•°ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
`index.ts`
useQuery ã‚„ useMutation ã‚’ä½¿ã£ãŸ hooks ã‚’ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
`key.ts`
queryKey ã«è¨˜è¼‰ã™ã‚‹ key ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
`selector.ts`
ä»Šå›ç´¹ä»‹ã¯ã—ã¦ã„ãªã„ãŒã€ useQuery ã«ã¯ select ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ãã“ã«å®šç¾©ã™ã‚‹é–¢æ•°ã‚’ç®¡ç†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
`type.ts`
ä¸Šè¨˜é–¢æ•°ã§ä½¿ç”¨ã™ã‚‹å‹ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚

ä¸Šè¨˜5ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚³ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œåˆ‡ã‚Šåˆ†ã‘ã‚‹ã€‚
:::details function.ts
https://github.com/49takaya3989/sample_tanstack-query/blob/main/src/service/task/function.ts
:::
:::details index.ts
https://github.com/49takaya3989/sample_tanstack-query/blob/main/src/service/task/index.ts
:::
:::details key.ts
https://github.com/49takaya3989/sample_tanstack-query/blob/main/src/service/task/key.ts
:::
:::details type.ts
https://github.com/49takaya3989/sample_tanstack-query/blob/main/src/service/task/type.ts
:::

ä»¥ä¸Šï¼

å‚è€ƒè¨˜äº‹
https://zenn.dev/taisei_13046/books/133e9995b6aadf/viewer/2ce93a
https://tanstack.com/query/latest/docs/framework/react/community/tkdodos-blog