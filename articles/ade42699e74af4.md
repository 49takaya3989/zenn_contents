---
title: "ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ Cypress ã‚’ä½¿ã£ã¦ E2E ãƒ†ã‚¹ãƒˆã‚’æ›¸ã"
emoji: "ğŸŒŸ"
type: "tech"
topics:
  - "react"
  - "e2e"
  - "vite"
  - "cypress"
published: true
published_at: "2024-07-25 10:00"
---

# ã¯ã˜ã‚ã«
ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰â†“
https://github.com/49takaya3989/sample_react_cypress

# é–‹ç™ºç’°å¢ƒ
```json
"react": "^18.3.1",
"vite": "^5.3.4"
"cypress": "^13.13.1",
"start-server-and-test": "^2.0.4",
```
# Cypress ã¨ã¯ï¼Ÿ
> Cypress comes fully baked, batteries included. Here is a list of things it can do that no other testing framework can:
>   - Time Travel: Cypress takes snapshots as your tests run. Hover over commands in the Command Log to see exactly what happened at each step.
>   - Debuggability: Stop guessing why your tests are failing. Debug directly from familiar tools like Developer Tools. Our readable errors and stack traces make debugging lightning fast.
>   - Automatic Waiting: Never add waits or sleeps to your tests. Cypress automatically waits for commands and assertions before moving on. No more async hell.
>   - Spies, Stubs, and Clocks: Verify and control the behavior of functions, server responses, or timers. The same functionality you love from unit testing is right at your fingertips.
>   - Network Traffic Control: Easily control, stub, and test edge cases without involving your server. You can stub network traffic however you like.
>   - Consistent Results: Our architecture doesn't use Selenium or WebDriver. Say hello to fast, consistent and reliable tests that are flake-free.
>   - Screenshots, Videos, and Test Replay: View screenshots taken automatically on failure, or videos, if enabled, of your entire test suite when run from the CLI. Record to Cypress Cloud and replay the test as it executed during the run for zero-configuration debugging using Test Replay.
>   - Cross Browser Testing: Run tests within Firefox and Chrome-family browsers (including Edge and Electron) locally and optimally in a Continuous Integration pipeline.
>   - Smart Orchestration: Once you're set up to record to Cypress Cloud, easily parallelize your test suite, rerun failed specs first with Spec Prioritization, and cancel test runs on failures with Auto Cancellation for tight feedback loops.
>   - Flake Detection: Discover and diagnose unreliable tests with Cypress Cloud's Flaky test management.
# Cypress ã‚’å°å…¥ã™ã‚‹
ä»Šå›ã¯ Vite + React + Typescript ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
ç’°å¢ƒæ§‹ç¯‰ã«é–¢ã—ã¦ã¯ä¸‹è¨˜ã‚’å‚ç…§ã€‚
https://zenn.dev/takaya39/articles/207e3e393081d9

Cypress ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```
npm install cypress --save-dev
```

npm scripts ã«ä¸‹è¨˜ã‚’è¿½åŠ ã™ã‚‹ã€‚
```json:package.json
"scripts": {
    ...
    "cy:open": "cypress open"
  },
```
Cypress ã‚’èµ·å‹•ã™ã‚‹ã€‚
```
npm run cy:open
```
ä»Šå›ã¯ã€Vite + React ã§ä½œæˆã—ã¦ã„ã‚‹ã®ã§ã€ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œå¾Œã«ä½œæˆã•ã‚ŒãŸ`cypress.config.ts`ã®ã‚³ãƒ¼ãƒ‰ã«ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚
```diff:cypress.config.ts
import { defineConfig } from "cypress";

export default defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
+   baseUrl: "http://localhost:8080",
  },
+ component: {
+   devServer: {
+     framework: "react",
+     bundler: "vite",
+   },
+ }
});

```
ä¸Šè¨˜æ‰‹é †ã§æ§‹ç¯‰ã—ã¦ã„ã‚‹ã¨ã€ãŠãã‚‰ãä¸‹è¨˜ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚
```
our configFile is invalid: [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹]/cypress.config.ts
It threw an error when required, check the stack trace below:
ReferenceError: exports is not defined in ES module scope
```
ã“ã®ã‚¨ãƒ©ãƒ¼ã¯`package.json`ã«`"type": "module"`ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€`ES module`ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã—ã¾ã†ãŸã‚ã€‚`"type": "module"`ã‚’å‰Šé™¤ã™ã‚‹ã€ã‚‚ã—ãã¯`cypress.config.ts`ã‚’`cypress.config.cts`ã«å¤‰æ›´ã—ãªã„ã¨ã„ã‘ãªã„ã€‚ä»Šå›ã¯ã€å‰è€…ã§å¯¾å¿œã™ã‚‹ã€‚

ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã™ã‚‹ã¨ä¸‹è¨˜ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
ä»Šå›ã¯ E2E ã‚’è¡Œã„ãŸã„ã®ã§ã€`E2E Testing`ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/03ec9b12c243-20240724.png)

`Chrome`ã‚’é¸æŠã™ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/d4c5df0de8d2-20240724.png)

`Create new spec`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/57aeb99f188e-20240724.png)

ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¦æˆåŠŸã™ã‚Œã°ã€ Cypress ã®å°å…¥ã¯æˆåŠŸï¼

# Cypress ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
ä¸Šè¨˜ã§ä½œæˆã—ãŸ`spec.cy.ts`ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã€‚
```diff:spec.cy.ts
describe('The Home Page', () => {
  it('passes', () => {
-    cy.visit('https://example.cypress.io')
+    cy.visit('http://localhost:8080')
  })
})
```
ã™ã‚‹ã¨ä¸‹è¨˜æ·»ä»˜ç”»åƒã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒã€ã€ã€
![](https://storage.googleapis.com/zenn-user-upload/cc0020c1fca4-20240724.png)

ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹å½“ãŸã‚‰ãªã„ã“ã¨ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚
è§£æ±ºæ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯[å…¬å¼](https://docs.cypress.io/guides/continuous-integration/introduction#Solutions:~:text=cypress%20run.-,start%2Dserver%2Dand%2Dtest%20module,-If%20the%20server)ã«è¨˜è¼‰ãŒã‚ã‚‹æ–¹æ³•ã§è¡Œã†ã€‚

ã¾ãšã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```
npm install --save-dev start-server-and-test
```
ä¸‹è¨˜ npm script ã‚’è¿½åŠ ã™ã‚‹ã€‚
`start-server-and-test [ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ script] [é–‹ç™ºç’°å¢ƒURL] cy:open`ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã¨è‰¯ã„ã€‚
```diff:json
"scripts": {
    ...
    "dev": "vite",
    "cy:open": "cypress open",
+   "cy:start-server-and-test": "start-server-and-test dev http://localhost:8080 cy:open"
  },
```

ç¾æ™‚ç‚¹ã§ã® Vite + React ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® UI ã¯ä¸‹è¨˜æ·»ä»˜ç”»åƒã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
:::details App.tsx
```tsx
import { useState } from 'react'
import reactLogo from './assets/react.svg'
import viteLogo from '/vite.svg'
import './App.css'

function App() {
  const [count, setCount] = useState(0)

  return (
    <>
      <div>
        <a href="https://vitejs.dev" target="_blank">
          <img src={viteLogo} className="logo" alt="Vite logo" />
        </a>
        <a href="https://react.dev" target="_blank">
          <img src={reactLogo} className="logo react" alt="React logo" />
        </a>
      </div>
      <h1>Vite + React</h1>
      <div className="card">
        <button onClick={() => setCount((count) => count + 1)}>
          count is {count}
        </button>
        <p>
          Edit <code>src/App.tsx</code> and save to test HMR
        </p>
      </div>
      <p className="read-the-docs">
        Click on the Vite and React logos to learn more
      </p>
    </>
  )
}

export default App
```
:::
![](https://storage.googleapis.com/zenn-user-upload/0a20eb2cb49b-20240725.png)

è©¦ã—ã«ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ã‚«ã‚¦ãƒ³ãƒˆãŒã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã‹ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã€‚
dom è¦ç´ ã®æŒ‡å®šã§ã‚‚å•é¡Œãªãå‹•ããŒã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒå¢—ãˆã‚‹ã“ã¨ã‚‚è€ƒæ…®ã—ã¦ã€å¯¾è±¡ dom è¦ç´ ã«ãƒ†ã‚¹ãƒˆç”¨ã®å±æ€§ã‚’ä»˜ä¸ã™ã‚‹ã€‚

```diff:App.tsx
-    <button onClick={() => setCount((count) => count + 1)}>
+    <button data-e2e="e2e-button" onClick={() => setCount((count) => count + 1)}>
```

[Cypress ã‚’å°å…¥ã™ã‚‹](#cypress-%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B)ã§ä½œæˆã—ãŸ`home.cy.ts`ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã«å·®ã—æ›¿ãˆã‚‹ã€‚

```ts:spec.cy.ts
describe('test', () => {
  it('count test', () => {
    cy.visit('/')
    cy.get(`[data-e2e="e2e-button"]`).click()
    expect(cy.get(`[data-e2e="e2e-button"]`).contains("count is 1"))
  })
})
```
`npm run cy:start-server-and-test`ã‚’å®Ÿè¡Œã—ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚Œã°æˆåŠŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/d2e72519af16-20240725.png)

å¿µã®ç‚ºã€å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è©¦ã—ã¦ã¿ã‚‹ã€‚
```diff:spec.cy.ts
- cy.get(`[data-e2e="e2e-button"]`).click()
+ cy.get(`[data-e2e="e2e-butto"]`).click()
```
![](https://storage.googleapis.com/zenn-user-upload/1017e39f2e32-20240725.png)

ã¡ã‚ƒã‚“ã¨å¤±æ•—ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã®ã§ã€æ­£å¸¸ã«ã‚³ãƒ¼ãƒ‰ãŒå‹•ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚

ä»¥ä¸Šï¼